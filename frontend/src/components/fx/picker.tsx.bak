'use client';

import React, { useEffect, useMemo, useRef, useState } from 'react';
import {
  eligibleCurrenciesFromExchanges,
  generatePairsFromCurrencies,
  orderPairsEastToWestWeighted,
  type ExchangeRec,
  type PairRec,
} from '@/lib/fx/eligibility';
import { useFxSelectionStore } from '@/lib/fx/selection.store';
import { track } from '@/lib/analytics';
import { regionOfCurrency } from '@/lib/geo/regions';
import flags from '@/data/flags.json';

type Props = {
  /** For ordering only; optional */
  visibleRails?: ExchangeRec[];
  /** Max pairs user may select (default 5) */
  maxPairs?: number;
  /** Free tier shows read-only trio */
  isPaid?: boolean;
  onClose?: () => void;
};

const MAX_FAVORITES = flags.fx.favoritesPin ? 2 : 0;

export default function FxPicker({
  visibleRails = [],
  maxPairs = 5,
  isPaid = true,
  onClose,
}: Props) {
  const { selectedIds, setSelectedIds, favorites, setFavorites } = useFxSelectionStore();
  const [local, setLocal] = useState<string[]>(selectedIds);
  const [search, _setSearch] = useState('');
  const [facet, _setFacet] = useState<'ALL' | 'EUROPE' | 'AMERICAS' | 'APAC' | 'MIDDLE_EAST' | 'AFRICA'>('ALL');

  const universe: PairRec[] = useMemo(() => {
    const eligible = eligibleCurrenciesFromExchanges();
    const all = generatePairsFromCurrencies(eligible);
    return orderPairsEastToWestWeighted(all, visibleRails);
  }, [visibleRails]);

  const _filtered: PairRec[] = useMemo(() => {
    const q = search.trim().toLowerCase();
    const match = (p: PairRec) =>
      !q || p.id.includes(q) || p.base.toLowerCase().includes(q) || p.quote.toLowerCase().includes(q);
    const inFacet = (p: PairRec) => {
      if (facet === 'ALL') {return true;}
      const a = regionOfCurrency(p.base);
      const b = regionOfCurrency(p.quote);
      return a === facet || b === facet;
    };
    return universe.filter((p) => match(p) && inFacet(p));
  }, [universe, search, facet]);

  const max = maxPairs;
  const isSelected = (id: string) => local.includes(id);
  const count = local.length;

  function _toggle(id: string) {
    if (isSelected(id)) {
      setLocal(local.filter((x) => x !== id));
      return;
    }
    if (count >= max) {
      setLocal([...local.slice(1), id]);
      return;
    }
    setLocal([...local, id]);
  }

  function _apply() {
    const safe = local.slice(0, max);
    setSelectedIds(safe);
    track('fx_apply_pairs', { count: safe.length });
    onClose?.();
  }

  function _resetToDefaults() {
    setLocal(['gbp-eur', 'gbp-usd', 'eur-usd'].slice(0, max));
  }

  function _toggleFavorite(id: string) {
    if (!flags.fx.favoritesPin) {return;}
    const has = favorites.includes(id);
    if (has) {
      setFavorites(favorites.filter((x) => x !== id));
      return;
    }
    const room = Math.max(0, MAX_FAVORITES - favorites.length);
    if (room === 0) {
      setFavorites([favorites[1] ?? favorites[0], id].slice(0, MAX_FAVORITES));
      return;
    }
    setFavorites([...favorites, id].slice(0, MAX_FAVORITES));
  }

  const [_showHelp, setShowHelp] = useState(false);
  const panelRef = useRef<HTMLDivElement>(null);
  useEffect(() => {
    function onKey(e: KeyboardEvent) {
      if (e.key === '?' || (e.shiftKey && e.key === '/')) {
        e.preventDefault();
        setShowHelp((v) => !v);
      }
    }
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, []);

  if (!isPaid) {
    return (
      <div className="w-full max-w-3xl mx-auto rounded-2xl border border-white/10 bg-white/5 backdrop-blur-md p-4">
        <h2 className="text-sm font-medium text-neutral-100 mb-1">FX Pairs</h2>
        <p className="text-xs text-neutral-400">Paid feature. Free view shows GBP/EUR, GBP/USD, EUR/USD.</p>
      </div>
    );
  }

  return (
    <div
      ref={panelRef}
      className="w-full max-w-4xl mx-auto rounded-2xl border border-white/10 bg-white/5 backdrop-blur-md p-4"
      role="dialog"
      aria-modal="true"
      aria-label="Choose FX pairs"
    >
      {/* Keep your existing UI body here (grid, search, presets, footer). */}
    </div>
  );
}



