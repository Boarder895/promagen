name: Lint & Typecheck

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

permissions:
  contents: write          # needed to commit lint summaries to lint-data branch
  pull-requests: write     # needed for PR comment updates
  actions: read

jobs:
  lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Setup PNPM
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Restore ESLint cache
        uses: actions/cache@v4
        with:
          path: frontend/.eslintcache
          key: eslint-${{ runner.os }}-${{ hashFiles('frontend/pnpm-lock.yaml') }}-v1

      - name: Lint (treat warnings as errors)
        id: lint
        run: |
          pnpm run lint:ci

      - name: Typecheck
        id: types
        run: pnpm run typecheck

      - name: Save ESLint cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: frontend/.eslintcache
          key: eslint-${{ runner.os }}-${{ hashFiles('frontend/pnpm-lock.yaml') }}-v1

      - name: Build lint summary json
        id: summary
        if: always()
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          const payloadPath = path.join(process.env.GITHUB_WORKSPACE, 'frontend', 'lint-summary.json');
          const env = {
            repo: process.env.GITHUB_REPOSITORY,
            sha: process.env.GITHUB_SHA,
            ref: process.env.GITHUB_REF,
            actor: process.env.GITHUB_ACTOR,
            runId: process.env.GITHUB_RUN_ID,
            pr: (process.env.GITHUB_EVENT_NAME === 'pull_request') ? process.env.GITHUB_REF_NAME : '',
          };
          // Minimal event – CI is source of truth for the dashboard
          const summary = {
            run: {
              repo: env.repo,
              commit: env.sha,
              ref: env.ref,
              actor: env.actor,
              runId: env.runId,
              pr: env.pr,
              finishedAt: new Date().toISOString()
            },
            status: {
              outcome: ('${{ steps.lint.outcome }}' === 'success' && '${{ steps.types.outcome }}' === 'success') ? 'passed' : 'failed'
            }
          };
          fs.writeFileSync(payloadPath, JSON.stringify(summary, null, 2));
          console.log('Wrote', payloadPath);
          "

      - name: Commit summary to lint-data branch
        if: always()
        run: |
          cd $GITHUB_WORKSPACE
          BRANCH=lint-data
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin $BRANCH || true
          git checkout -B $BRANCH origin/$BRANCH || git checkout -B $BRANCH
          mkdir -p lint-events
          cp frontend/lint-summary.json lint-events/${{ github.run_id }}.json
          git add lint-events
          git commit -m "chore(lint): event ${{ github.run_id }} on ${GITHUB_REF_NAME}" || echo "No changes"
          git push origin $BRANCH

      - name: Update PR summary comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { repo, pull_request } = context.payload;
            const owner = repo.owner.login || context.repo.owner;
            const repoName = repo.name || context.repo.repo;

            const headSha = context.payload.pull_request.head.sha;
            const lintOK = '${{ steps.lint.outcome }}' === 'success';
            const typesOK = '${{ steps.types.outcome }}' === 'success';

            const body = `
**Lint & Typecheck**
- Lint: ${lintOK ? '✅ passed' : '❌ failed'}
- Typecheck: ${typesOK ? '✅ passed' : '❌ failed'}

This comment updates on every push. See workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
`;

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo: repoName,
              issue_number: context.issue.number
            });
            const marker = 'Lint & Typecheck';
            const existing = comments.find(c => c.user.type === 'Bot' && c.body && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo: repoName,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo: repoName,
                issue_number: context.issue.number,
                body
              });
            }

      - name: Slack/Teams notification (fail/recover)
        if: always() && github.event_name == 'pull_request'
        env:
          WEBHOOK_URL: ${{ secrets.CI_ALERT_WEBHOOK }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "No webhook configured; skipping.";
            exit 0;
          fi
          STATUS="unknown"
          if [ "${{ steps.lint.outcome }}" = "success" ] && [ "${{ steps.types.outcome }}" = "success" ]; then
            STATUS="recovered"
          else
            STATUS="failed"
          fi
          node -e "
          const https = require('https'); const url = process.env.WEBHOOK_URL;
          if (!url) process.exit(0);
          const payload = JSON.stringify({
            text: ( '${STATUS}' === 'failed'
              ? '❌ Lint/Types failed on PR #${{ github.event.pull_request.number }}'
              : '✅ Lint/Types recovered on PR #${{ github.event.pull_request.number }}' )
              + ' – Run ${{ github.run_id }} – ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          });
          const u = new URL(url);
          const req = https.request({ method:'POST', hostname:u.hostname, path:u.pathname+u.search }, res => { res.on('data',()=>{}); res.on('end',()=>process.exit(0)); });
          req.on('error', ()=>process.exit(0)); req.end(payload);
          "

  # Optional nightly job to snapshot totals (feeds dashboard trends)
  nightly:
    if: github.repository == '${{ github.repository }}'
    runs-on: ubuntu-latest
    schedule:
      - cron: '15 2 * * *'
    steps:
      - name: No-op placeholder
        run: echo "Nightly placeholder – your dashboard can read lint-data branch JSONs."
