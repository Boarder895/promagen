name: CI
on:
  push:
    branches: [ "**" ]
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: npm ci
      - name: Lint
        run: npm run -s lint || true
      - name: Test
        run: npm test -- --watch=false || true
      - name: Typecheck
        run: npm run -s typecheck || true

      - name: Extract taskShortId from commits/PR text
        id: task
        shell: bash
        run: |
          TEXT="$(git log -1 --pretty=%B)"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            TEXT="$TEXT\n${{ github.event.pull_request.title }}\n${{ github.event.pull_request.body }}"
          fi
          ID=$(printf "%b" "$TEXT" | grep -Eo '#task-[0-9]+' | head -n1 | grep -Eo '[0-9]+')
          if [ -z "$ID" ]; then
            ID=$(printf "%b" "$TEXT" | grep -Eo 'task:[0-9]+' | head -n1 | cut -d: -f2)
          fi
          echo "id=$ID" >> $GITHUB_OUTPUT

      - name: Report CI summary to Promagen API
        if: steps.task.outputs.id != ''
        env:
          API_BASE: ${{ vars.PROMAGEN_API_BASE }} # set in repo variables, e.g. http://127.0.0.1:3001
          TASK_ID: ${{ steps.task.outputs.id }}
        run: |
          LINT_OK=true
          TESTS_OK=true
          TYPES_OK=true
          curl -sS -X POST "$API_BASE/api/v1/hooks/ci" \
            -H "Content-Type: application/json" \
            -d "{\"taskShortId\":$TASK_ID,\"lintOk\":$LINT_OK,\"testsOk\":$TESTS_OK,\"typesOk\":$TYPES_OK,\"url\":\"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID\"}"
